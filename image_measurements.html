<div id="selectedImagePanel">
    <!--<img id="selectedImage" src="{{  selected_image.annotated_image_uri  }}" style="width:100%"> -->
    <canvas id="selectedImage" />
    <script>
        
        function DisplayImageWithMeasurements(rect_list, image_source, image_width, image_height){
            
            var margin = 150;
            //create new canvas, context and image objects
            var newCanvas = document.getElementById('selectedImage'); 
            var newContext = newCanvas.getContext('2d');
            var newimg = new Image();        
            newimg.src = image_source;       
            
            //set size of canvas based on the image plus a margin of 150px in case measurements extend beyond image limits
            canvas_width = image_width + margin ;
            canvas_height = image_height + margin;

            newCanvas.width = canvas_width;
            newCanvas.height = canvas_height;

            
            newimg.onload = () => {  
                //offset the image by half the margin value horizontally and vertically       
                var offset = margin / 2;
                newContext.drawImage(newimg, offset, offset);

                //step through each rectangle on the rect_list
                for(i = 0; i < rect_list.length; i++){
                    
                    //coordinates of each point in the line
                    top_right_x = rect_list[i][0] + offset;
                    top_right_y = rect_list[i][1] + offset;
                    bottom_right_x = rect_list[i][2] + offset;
                    bottom_right_y = rect_list[i][3] + offset;
                    bottom_left_x = rect_list[i][4] + offset;
                    bottom_left_y = rect_list[i][5] + offset;
                    //angle to draw line
                    angle = rect_list[i][6];
                    //length and width values in pixels
                    pixel_length = rect_list[i][7];
                    pixel_width = rect_list[i][8];
                    //convert to microns
                    length = Math.round(pixel_length / MICRON_TO_PIXEL_VALUE)
                    width = Math.round(pixel_width / MICRON_TO_PIXEL_VALUE)

                    //offset values for positioning of labels
                    length_offset = (pixel_width / 2) + 20
                    width_offset = (pixel_length / 2) + 20
                    //rotation values for labels
                    length_rotation = angle - 90
                    width_rotation = angle

                    newContext.beginPath();
                    newContext.moveTo(top_right_x, top_right_y);
                    newContext.lineTo(bottom_right_x, bottom_right_y);
                    newContext.lineTo(bottom_left_x, bottom_left_y);
                    newContext.strokeStyle = 'gray';
                    newContext.lineWidth = 2;
                    newContext.stroke();    

                    newContext.font = "16px Arial";

                    newContext.save();
                    newContext.translate(bottom_left_x, bottom_left_y);
                    
                    radians_angle = (length_rotation * Math.PI) /180;
                    newContext.rotate(radians_angle);
                    newContext.textAlign = 'left';
                    newContext.fillText(length + "\u00B5", 0, 15);
                    newContext.restore();

                    newContext.save();
                    newContext.translate(top_right_x, top_right_y);
                    radians_angle = (width_rotation * Math.PI) /180;
                    newContext.rotate(radians_angle);
                    newContext.textAlign = 'left';
                    newContext.fillText(width + "\u00B5", 0, -10);
                    newContext.restore();
                };        
            };
        } 
        
        const MICRON_TO_PIXEL_VALUE = 2.77;
        //these vars should be generated by server side code and passed to the html template as variables.
        rect_list = [[35, 19, 52, 19, 52, 37, 0.0, 18.0, 17.0]]
        image_source = './images/bead/D20240228T113410_IFCB147_00867.png';

        //create a new instance of the source image and bind an onload event - this is needed to get width and height of source image
        var new_image = new Image();        
        new_image.src = image_source;       
        
        new_image.onload = function() {
            var image_width = new_image.width;
            var image_height = new_image.height;
            DisplayImageWithMeasurements(rect_list, image_source, image_width, image_height);
        };
        
    </script>
</div>